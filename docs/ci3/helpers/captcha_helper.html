<!DOCTYPE html>


<html>
	<head>
		<meta charset="utf-8">
	    
	    <title>CAPTCHA Helper &mdash; CodeIgniter 3.0-dev documentation</title>

	    <link rel="stylesheet" href="../_static/asset/css/common.css" type="text/css" />
	    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
	    <script type="text/javascript">
	      var DOCUMENTATION_OPTIONS = {
	        URL_ROOT:    '../',
	        VERSION:     '3.0-dev',
	        COLLAPSE_INDEX: false,
	        FILE_SUFFIX: '.html',
	        HAS_SOURCE:  false
	      };
	    </script>
	    <script type="text/javascript" src="../_static/jquery.js"></script>
	    <script type="text/javascript" src="../_static/underscore.js"></script>
	    <script type="text/javascript" src="../_static/doctools.js"></script>

	    <script type="text/javascript" src="../_static/asset/js/method-toc.js"></script>
	    <link rel="top" title="CodeIgniter 3.0-dev documentation" href="../index.html" />
	    <link rel="up" title="Helpers" href="index.html" />
	    <link rel="next" title="Cookie Helper" href="cookie_helper.html" />
	    <link rel="prev" title="Array Helper" href="array_helper.html" /> 
	</head>
	<body>
		<div id="table-contents">
			<div class="toctree-wrapper compound">
			<function <lambda> at 0x3d28e60>
			</div>
		</div>

		<div id="brand" class="ci">
			<a href="http://codeigniter.com/"><img src="../_static/asset/img/ci-logo.gif" alt="CodeIgniter"></a>
			<p>3.0-dev User Guide</p>
		</div><!-- /#brand -->

		<div id="header"><!--
	--------------------------------
	Original Google search box block
	--------------------------------
	
<form method="get" action="http://www.google.com/search">
	<fieldset>
		<input type="text" name="q" id="q" value="">
		<input type="hidden" name="as_sitesearch" id="as_sitesearch" value="codeigniter.com/user_guide/" />
		<input class="grades" type="submit" value="search">
	</fieldset>
</form>
-->


<form class="search" action="../search.html" method="get">
  <input type="text" name="q" id="q" value="" />
  <input type="submit" value="search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
			<ul>
				<li><a href="../index.html">User Guide Home</a>&nbsp;&nbsp; &rsaquo;</li>
				<li><a href="index.html" accesskey="U">Helpers</a>&nbsp;&nbsp;  &rsaquo;</li>
				<li><strong>CAPTCHA Helper</strong></li>
			</ul>
		</div><!-- /#header -->

		<div class="section body" id="content">
  <div class="section" id="captcha-helper">
<h1>CAPTCHA Helper<a class="headerlink" href="#captcha-helper" title="Permalink to this headline">¶</a></h1>
<p>The CAPTCHA Helper file contains functions that assist in creating
CAPTCHA images.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#loading-this-helper" id="id1">Loading this Helper</a></li>
<li><a class="reference internal" href="#using-the-captcha-helper" id="id2">Using the CAPTCHA helper</a><ul>
<li><a class="reference internal" href="#adding-a-database" id="id3">Adding a Database</a></li>
</ul>
</li>
<li><a class="reference internal" href="#available-functions" id="id4">Available Functions</a></li>
</ul>
</div>
<div class="custom-index container"></div><div class="section" id="loading-this-helper">
<h2><a class="toc-backref" href="#id1">Loading this Helper</a><a class="headerlink" href="#loading-this-helper" title="Permalink to this headline">¶</a></h2>
<p>This helper is loaded using the following code:</p>
<div class="highlight-ci"><div class="highlight"><pre>$this-&gt;load-&gt;helper(&#39;captcha&#39;);
</pre></div>
</div>
</div>
<div class="section" id="using-the-captcha-helper">
<h2><a class="toc-backref" href="#id2">Using the CAPTCHA helper</a><a class="headerlink" href="#using-the-captcha-helper" title="Permalink to this headline">¶</a></h2>
<p>Once loaded you can generate a CAPTCHA like this:</p>
<div class="highlight-ci"><div class="highlight"><pre>$vals = array(
        &#39;word&#39;          =&gt; &#39;Random word&#39;,
        &#39;img_path&#39;      =&gt; &#39;./captcha/&#39;,
        &#39;img_url&#39;       =&gt; &#39;http://example.com/captcha/&#39;,
        &#39;font_path&#39;     =&gt; &#39;./path/to/fonts/texb.ttf&#39;,
        &#39;img_width&#39;     =&gt; &#39;150&#39;,
        &#39;img_height&#39;    =&gt; 30,
        &#39;expiration&#39;    =&gt; 7200,
        &#39;word_length&#39;   =&gt; 8,
        &#39;pool&#39;          =&gt; &#39;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;,

        // White background and border, black text and red grid
        &#39;colors&#39;        =&gt; array(
                &#39;background&#39; =&gt; array(255, 255, 255),
                &#39;border&#39; =&gt; array(255, 255, 255),
                &#39;text&#39; =&gt; array(0, 0, 0),
                &#39;grid&#39; =&gt; array(255, 40, 40)
        )
);

$cap = create_captcha($vals);
echo $cap[&#39;image&#39;];
</pre></div>
</div>
<ul class="simple">
<li>The captcha function requires the GD image library.</li>
<li>Only the <strong>img_path</strong> and <strong>img_url</strong> are required.</li>
<li>If a <strong>word</strong> is not supplied, the function will generate a random
ASCII string. You might put together your own word library that you
can draw randomly from.</li>
<li>If you do not specify a path to a TRUE TYPE font, the native ugly GD
font will be used.</li>
<li>The &#8220;captcha&#8221; folder must be writable (666, or 777)</li>
<li>The <strong>expiration</strong> (in seconds) signifies how long an image will remain
in the captcha folder before it will be deleted. The default is two
hours.</li>
<li><strong>word_length</strong> defaults to 8, <strong>pool</strong> defaults to &#8216;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#8217;</li>
<li>If any of the <strong>colors</strong> values is missing, it will be replaced by the default.</li>
</ul>
<div class="section" id="adding-a-database">
<h3><a class="toc-backref" href="#id3">Adding a Database</a><a class="headerlink" href="#adding-a-database" title="Permalink to this headline">¶</a></h3>
<p>In order for the captcha function to prevent someone from submitting,
you will need to add the information returned from <tt class="docutils literal"><span class="pre">create_captcha()</span></tt>
to your database. Then, when the data from the form is submitted by
the user you will need to verify that the data exists in the database
and has not expired.</p>
<p>Here is a table prototype:</p>
<div class="highlight-ci"><div class="highlight"><pre>CREATE TABLE captcha (
        captcha_id bigint(13) unsigned NOT NULL auto_increment,
        captcha_time int(10) unsigned NOT NULL,
        ip_address varchar(45) NOT NULL,
        word varchar(20) NOT NULL,
        PRIMARY KEY `captcha_id` (`captcha_id`),
        KEY `word` (`word`)
);
</pre></div>
</div>
<p>Here is an example of usage with a database. On the page where the
CAPTCHA will be shown you&#8217;ll have something like this:</p>
<div class="highlight-ci"><div class="highlight"><pre>$this-&gt;load-&gt;helper(&#39;captcha&#39;);
$vals = array(
        &#39;img_path&#39;      =&gt; &#39;./captcha/&#39;,
        &#39;img_url&#39;       =&gt; &#39;http://example.com/captcha/&#39;
);

$cap = create_captcha($vals);
$data = array(
        &#39;captcha_time&#39;  =&gt; $cap[&#39;time&#39;],
        &#39;ip_address&#39;    =&gt; $this-&gt;input-&gt;ip_address(),
        &#39;word&#39;          =&gt; $cap[&#39;word&#39;]
);

$query = $this-&gt;db-&gt;insert_string(&#39;captcha&#39;, $data);
$this-&gt;db-&gt;query($query);

echo &#39;Submit the word you see below:&#39;;
echo $cap[&#39;image&#39;];
echo &#39;&lt;input type=&quot;text&quot; name=&quot;captcha&quot; value=&quot;&quot; /&gt;&#39;;
</pre></div>
</div>
<p>Then, on the page that accepts the submission you&#8217;ll have something like
this:</p>
<div class="highlight-ci"><div class="highlight"><pre>// First, delete old captchas
$expiration = time() - 7200; // Two hour limit
$this-&gt;db-&gt;where(&#39;captcha_time &lt; &#39;, $expiration)
        -&gt;delete(&#39;captcha&#39;);

// Then see if a captcha exists:
$sql = &#39;SELECT COUNT(*) AS count FROM captcha WHERE word = ? AND ip_address = ? AND captcha_time &gt; ?&#39;;
$binds = array($_POST[&#39;captcha&#39;], $this-&gt;input-&gt;ip_address(), $expiration);
$query = $this-&gt;db-&gt;query($sql, $binds);
$row = $query-&gt;row();

if ($row-&gt;count == 0)
{
        echo &#39;You must submit the word that appears in the image.&#39;;
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="available-functions">
<h2><a class="toc-backref" href="#id4">Available Functions</a><a class="headerlink" href="#available-functions" title="Permalink to this headline">¶</a></h2>
<p>The following functions are available:</p>
<dl class="function">
<dt id="create_captcha">
<tt class="descname">create_captcha</tt><big>(</big><span class="optional">[</span><em>$data = ''</em><span class="optional">[</span>, <em>$img_path = ''</em><span class="optional">[</span>, <em>$img_url = ''</em><span class="optional">[</span>, <em>$font_path = ''</em><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#create_captcha" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>$data</strong> (<em>array</em>) &#8211; Array of data for the CAPTCHA</li>
<li><strong>$img_path</strong> (<em>string</em>) &#8211; Path to create the image in</li>
<li><strong>$img_url</strong> (<em>string</em>) &#8211; URL to the CAPTCHA image folder</li>
<li><strong>$font_path</strong> (<em>string</em>) &#8211; Server path to font</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">array(&#8216;word&#8217; =&gt; $word, &#8216;time&#8217; =&gt; $now, &#8216;image&#8217; =&gt; $img)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">array</p>
</td>
</tr>
</tbody>
</table>
<p>Takes an array of information to generate the CAPTCHA as input and
creates the image to your specifications, returning an array of
associative data about the image.</p>
<div class="highlight-ci"><div class="highlight"><pre>array(
        &#39;image&#39; =&gt; IMAGE TAG
        &#39;time&#39;  =&gt; TIMESTAMP (in microtime)
        &#39;word&#39;  =&gt; CAPTCHA WORD
)
</pre></div>
</div>
<p>The <strong>image</strong> is the actual image tag:</p>
<div class="highlight-ci"><div class="highlight"><pre>&lt;img src=&quot;http://example.com/captcha/12345.jpg&quot; width=&quot;140&quot; height=&quot;50&quot; /&gt;
</pre></div>
</div>
<p>The <strong>time</strong> is the micro timestamp used as the image name without the
file extension. It will be a number like this: 1139612155.3422</p>
<p>The <strong>word</strong> is the word that appears in the captcha image, which if not
supplied to the function, will be a random string.</p>
</dd></dl>

</div>
</div>


		</div>

		<!-- {user_guide_comments} -->
		
		<div id="footer">
			<p class="top"><a href="#header" title="Return to top">Return to top</a></p>
			<p><a href="http://codeigniter.com/">CodeIgniter</a> &ndash; Copyright &copy; 2014, EllisLab, Inc.</a></p>
		</div><!-- /#footer -->
	</body>
</html>